# Certbot CA Renewal Deployment with Netbox DCIM

This repository provides an automated kit to update/deploy new certificates issued by Certbot (LetsEncrypt's automated certificate provisioning tool) to remote servers. It is meant to be invoked by Certbot itself using Certbot's `renew_hook` functionality. The scripts herein utilize Netbox (https://github.com/netbox-community/netbox), a DCIM/IPAM tool created by Digital Ocean to manage which servers receive which certificate. 

While this was designed primarily to push out wildcard certificates to hosts after they have been renewed, it can really work for any certificate generated by Certbot.

The functionality is easy to update to use with another DCIM tool with an http/s api, Netbox happens to be my preferred tool.

## Requirements

This script assumes and requires the following: 

- The following packages: 
  - `jq`
  - `curl`
  - `openssh`
- A configured Netbox instance running somewhere on the network
    - A valid Netbox API Key 
    - Virtual Machies/Devices defined in Netbox
    - Tags defined in Netbox for hosts, matching the pattern `certauthority_sitename.com`, where "sitename.com" is the name of the certificate from Certbot (find your certificate name using `certbot certificates`)
- A Certbot instance that is renewing certificates (`deploy.sh` should be called from the Certbot `renew_hook` method.)
- An ssh key added to all managed servers with write access to the target directory (defined in `settings.json`, manually for now)

## Upcoming Additions

- Static JSON configuration of hosts
- Enable/disable physical hosts
- Custom destination directories/overrides depending on OS (Netbox and Static host configuration)
- Windows IIS Support (?)
  - Unlikely to be implemented soon, IIS has a different certificate structure than LetsEncrypt currently puts out. It likes *.pfx files, instead of cert chain+key files. 
  - Will most likely require Powershell to effectively communicate with IIS. Will require WinRM enabled on the desitnation servers to make use of Powershell remote connections.
- Better way to define ssh host keys for hosts or groups of hosts
