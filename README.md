# Certbot CA Renewal Deployment with Netbox DCIM

This repository provides an automated kit to update/deploy new certificates issued by Certbot (LetsEncrypt's automated certificate provisioning tool) to remote servers. It is meant to be invoked by Certbot itself (via `runner.sh`) using Certbot's `renew_hook` functionality. The scripts herein utilize Netbox (https://github.com/netbox-community/netbox), a DCIM/IPAM tool created by Digital Ocean to manage which servers receive which certificate. 

While this was designed primarily to push out wildcard certificates to hosts after they have been renewed, it can really work for any certificate generated by Certbot.

The functionality is easy to update to use with another DCIM tool with an http/s api, Netbox happens to be my preferred tool.

## Requirements

This script assumes and requires the following: 

- A configured Netbox instance running somewhere on the network
    - A valid Netbox API Key 
    - Virtual Machies/Devices defined in Netbox
    - Tags defined in Netbox for hosts, matching the pattern `certauthority_sitename.com`, where "sitename.com" is the name of the certificate from Certbot (find your certificate name using `certbot certificates`)
- A Certbot instance that is renewing certificates
- A python virtual environment (configured by `setup.sh` in this repository)

## Upcoming Additions

- Static JSON configuration of hosts
- Configurable Netbox tag beginnings (instead of `certauthority_*`)
- Enable/disable physical hosts
- Custom destination directories/overrides depending on OS (Netbox and Static host configuration)
- Windows IIS Support (?)
  - Unlikely to be implemented soon, IIS has a different certificate structure than LetsEncrypt currently puts out. It likes *.pfx files, instead of cert chain+key files. 
  - Will most likely be written Powershell to effectively communicate with IIS
- Cleanup shebang in main.py, and hacky sed rewrite in setup.sh
- Better way to define ssh host keys for hosts or groups of hosts

## NOTE: 

Windows is currently untested. `setup.ps1` is included more of as a Windows excersise, as well as for anyone who runs powershell on linux. Don't expect everything to work swimmingly in Windows, as Windows Python does not subscribe to the same virtual environment naming conventions or python executable naming conventions, among other issues.  